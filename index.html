<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×—×‘×¨×•×ª ××–×™×™×¤×•×ª - ×©×™× ×•×™ ×¡×•×œ× ×œ××•×–×™×§×”</title>
    <script>
        // Set base href dynamically based on environment
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            // Production (GitHub Pages)
            document.write('<base href="/Transpose/">');
        }
        // Local development uses root path (no base tag needed)
    </script>
    <meta name="description" content="×©×™× ×•×™ ×¡×•×œ× ××§×¦×•×¢×™ ×œ××•×–×™×§×” ×©×œ×š">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×—×‘×¨×•×ª ××–×™×™×¤×•×ª">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        .song-card {
            transition: all 0.3s ease;
        }
        
        .song-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        /* Horizontal song list scrollbar styling */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Smooth scrolling for song list */
        .overflow-x-auto {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    
    <div id="app-content"></div>
    
    <script>
        // GitHub Pages SPA redirect handler
        (function() {
            var redirect = sessionStorage.redirect;
            delete sessionStorage.redirect;
            if (redirect && redirect != location.href) {
                history.replaceState(null, null, redirect);
            }
        })();
        
        // Load manifest and render appropriate page
        async function init() {
            try {
                const response = await fetch('public/tracks.manifest.json');
                const manifest = await response.json();
                // Remove base path (if on GitHub Pages) and leading/trailing slashes
                let path = window.location.pathname;
                
                // On GitHub Pages, strip /Transpose/ prefix
                if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    path = path.replace(/^\/Transpose\/?/i, '');
                }
                
                // Clean up path
                path = path.replace(/^\/+|\/+$/g, '');
                
                if (!path || path === 'index.html') {
                    // Show all tracks
                    renderHomePage(manifest.tracks);
                } else if (manifest.collections && manifest.collections[path]) {
                    // Show collection
                    const collection = manifest.collections[path];
                    const collectionTracks = collection.tracks
                        .map(trackId => manifest.tracks.find(t => t.id === trackId))
                        .filter(t => t); // Remove nulls
                    renderHomePage(collectionTracks, collection.name);
                } else {
                    // Show individual track player
                    const track = manifest.tracks.find(t => t.id === path);
                    if (track) {
                        renderPlayerPage(track);
                    } else {
                        render404();
                    }
                }
            } catch (error) {
                console.error('Error loading:', error);
                renderError(error.message);
            }
        }
        
        function renderHomePage(tracks, collectionName = null) {
            const title = collectionName ? `${collectionName} - ×—×‘×¨×•×ª ××–×™×™×¤×•×ª` : '×—×‘×¨×•×ª ××–×™×™×¤×•×ª - ×‘×—×¨ ×©×™×¨';
            document.title = title;
            
            document.getElementById('app-content').innerHTML = `
                <div class="flex flex-col min-h-screen">
                    <!-- Top Bar with Song List -->
                    <div class="bg-white border-b border-gray-200 shadow-sm flex-shrink-0">
                        <div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50">
                            <div class="max-w-7xl mx-auto">
                                <div class="flex items-center gap-3 mb-3">
                                    <h1 class="text-2xl font-bold text-gray-800">×—×‘×¨×•×ª ××–×™×™×¤×•×ª</h1>
                                    ${collectionName ? `<h2 class="text-lg font-semibold text-gray-700">â€¢ ${escapeHtml(collectionName)}</h2>` : ''}
                                </div>
                                
                                <!-- Horizontal Song List -->
                                <div class="overflow-x-auto">
                                    <div id="song-list" class="flex gap-3 pb-2">
                                        ${tracks.map(track => `
                                            <div class="song-item flex-shrink-0 w-48 p-3 bg-white hover:bg-blue-50 rounded-lg cursor-pointer transition border-2 border-transparent hover:border-blue-400 shadow-sm" data-track-id="${track.id}">
                                                <h3 class="font-semibold text-gray-800 text-sm truncate">${escapeHtml(track.title)}</h3>
                                                <p class="text-xs text-gray-600 truncate">${escapeHtml(track.artist)}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Player Area -->
                    <div class="flex-1 flex flex-col">
                        <div class="flex-1 flex items-center justify-center p-8 bg-gradient-to-br from-blue-50 to-purple-50">
                            <div class="w-full max-w-2xl">
                                <div id="player-container">
                                    <div class="text-center text-gray-400 py-20">
                                        <div class="text-6xl mb-4">ğŸ§</div>
                                        <p class="text-xl">×‘×—×¨ ×©×™×¨ ×œ×”×ª×—×œ×”</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white border-t border-gray-200 p-4 text-center text-sm text-gray-600 shadow-sm flex-shrink-0">
                            <p dir="ltr">âŒ¨ï¸ Shortcuts: <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">Space</kbd> Play/Pause â€¢ 
                            <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†</kbd> -5s â€¢ 
                            <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†’</kbd> +5s â€¢
                            <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†‘</kbd> Pitch+ â€¢
                            <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†“</kbd> Pitch-</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Setup song selection
            setupSongList(tracks);
        }
        
        function renderPlayerPage(track) {
            document.title = `${track.title} - ×—×‘×¨×•×ª ××–×™×™×¤×•×ª`;
            document.getElementById('app-content').innerHTML = `
                <div class="min-h-screen bg-gray-50 flex flex-col">
                    <!-- Header -->
                    <div class="bg-white border-b border-gray-200 p-4 shadow-sm">
                        <div class="max-w-4xl mx-auto flex items-center justify-between">
                            <a href="./" class="text-blue-600 hover:text-blue-700 flex items-center font-semibold">
                                <span class="ml-2">â†’</span>
                                <span>×—×–×¨×” ×œ×©×™×¨×™×</span>
                            </a>
                            <div class="text-center">
                                <h1 class="text-xl font-bold text-gray-800">${escapeHtml(track.title)}</h1>
                                <p class="text-sm text-gray-600">${escapeHtml(track.artist)}</p>
                            </div>
                            <div class="w-24"></div>
                        </div>
                    </div>
                    
                    <!-- Player -->
                    <div class="flex-1 flex items-center justify-center p-8 bg-gradient-to-br from-blue-50 to-purple-50">
                        <div class="w-full max-w-2xl">
                            <div id="player-container"></div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="bg-white border-t border-gray-200 p-4 text-center text-sm text-gray-600 shadow-sm">
                        <p dir="ltr">âŒ¨ï¸ Shortcuts: <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">Space</kbd> Play/Pause â€¢ 
                        <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†</kbd> -5s â€¢ 
                        <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†’</kbd> +5s â€¢
                        <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†‘</kbd> Pitch+ â€¢
                        <kbd class="px-2 py-1 bg-gray-100 rounded border border-gray-300">â†“</kbd> Pitch-</p>
                    </div>
                </div>
            `;
            
            // Load player script
            loadPlayer(track);
        }
        
        function render404() {
            document.title = '×œ× × ××¦× - ×—×‘×¨×•×ª ××–×™×™×¤×•×ª';
            document.getElementById('app-content').innerHTML = `
                <div class="min-h-screen gradient-bg flex items-center justify-center p-8">
                    <div class="text-center">
                        <div class="text-8xl mb-4">ğŸµ</div>
                        <h1 class="text-4xl font-bold mb-4">Song Not Found</h1>
                        <p class="text-xl text-gray-300 mb-8">The song you're looking for doesn't exist.</p>
                        <a href="./" class="inline-block bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                            Back to Home
                        </a>
                    </div>
                </div>
            `;
        }
        
        function renderError(message) {
            document.getElementById('app-content').innerHTML = `
                <div class="min-h-screen bg-gray-900 flex items-center justify-center p-8">
                    <div class="text-center">
                        <div class="text-8xl mb-4">âš ï¸</div>
                        <h1 class="text-4xl font-bold mb-4 text-red-400">Error</h1>
                        <p class="text-xl text-gray-300 mb-8">${escapeHtml(message)}</p>
                    </div>
                </div>
            `;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        let allTracks = [];
        let preloadedSongs = new Set();
        
        
        async function preloadCollectionSongs(tracks) {
            console.log(`\nğŸ“¦ Preloading ${tracks.length} songs for collection...`);
            
            let loaded = 0;
            for (const track of tracks) {
                try {
                    // Preload pitch 0 (original) for each song
                    const filename = track.src.replace(/^.*[\\\/]/, '').replace('.mp3', '');
                    const audioUrl = `public/audio/pitched/${filename}_0.mp3`;
                    
                    const response = await fetch(audioUrl);
                    if (response.ok) {
                        await response.arrayBuffer(); // Force download
                        preloadedSongs.add(track.id);
                        loaded++;
                        console.log(`  âœ“ Preloaded ${loaded}/${tracks.length}: ${track.title}`);
                    }
                } catch (error) {
                    console.warn(`  âš ï¸ Failed to preload: ${track.title}`, error);
                }
            }
            
            console.log(`\nâœ“ Collection preloading complete: ${loaded}/${tracks.length} songs ready\n`);
        }
        
        function setupSongList(tracks) {
            allTracks = tracks;
            const songItems = document.querySelectorAll('.song-item');
            
            songItems.forEach(item => {
                item.addEventListener('click', () => {
                    const trackId = item.dataset.trackId;
                    const track = allTracks.find(t => t.id === trackId);
                    if (track) {
                        console.log(`\nğŸµ User selected song: ${track.title}`);
                        
                        // Update active state - highlight selected song
                        songItems.forEach(si => {
                            si.classList.remove('bg-blue-100', 'border-blue-500');
                            si.classList.add('border-transparent');
                        });
                        item.classList.add('bg-blue-100', 'border-blue-500');
                        item.classList.remove('border-transparent');
                        
                        // Scroll selected song into view (center it)
                        item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        
                        // Load player (user gesture = AudioContext can start)
                        loadPlayer(track);
                    }
                });
            });
            
            // NO AUTO-SELECT - User must explicitly choose a song
            // This ensures AudioContext starts with a proper user gesture
            console.log('âœ“ Song list ready. User must select a song to start playing.');
            
            // Check if this is collection mode (has multiple tracks) and preload in background
            const isCollectionMode = tracks.length > 1 && window.location.pathname.includes('/');
            if (isCollectionMode) {
                // Start preloading in background after a short delay (silent, no UI indication)
                setTimeout(() => preloadCollectionSongs(tracks), 500);
            }
        }
        
        // Initialize on load
        init();
    </script>
    
    <!-- Player Script (loaded dynamically) -->
    <script src="player.js"></script>
</body>
</html>
